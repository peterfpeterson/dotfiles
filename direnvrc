# required for things to work - copied directly from direnv
direnv_layout_dir() {
  echo "${direnv_layout_dir:-$PWD/.direnv}"
}

########## https://github.com/direnv/direnv/pull/311

# this wins out over system version
layout_python() {
  # get supplied python version
  local python=${1:-python}
  [[ $# -gt 0 ]] && shift

  local old_env=$(direnv_layout_dir)/virtualenv
  unset PYTHONHOME
  if [[ -d $old_env && $python = python ]]; then
    export VIRTUAL_ENV=$old_env
  else
    local python_version
    python_version=$("$python" -c "import platform as p;print(p.python_version())")
    if [[ -z $python_version ]]; then
      log_error "Could not find python's version"
      return 1
    fi

    export VIRTUAL_ENV=$(direnv_layout_dir)/python-$python_version
    if [[ ! -d $VIRTUAL_ENV ]]; then
      # see if VIRTUALENV has been injected
      local virtualenv=$VIRTUALENV_BIN
      if [[ -z $virtualenv ]]; then
          virtualenv=virtualenv
      fi
      if [[ ! $(command -v $virtualenv) ]]; then
        log_error "Could not find virtualenv executable \"$virtualenv\""
        return 1
      fi
      # create the new environment
      "$virtualenv" "--python=$python" "$@" "$VIRTUAL_ENV"
    fi
  fi
  PATH_add "$VIRTUAL_ENV/bin"
}
